# HTTPS VS HTTP

## HTTP的问题

1. 明文传输（被窃听）
2. 信息篡改（收到被篡改的数据）
3. 冒充（收到非官方的、假冒的数据）



## HTTPS的安全措施

在TCP和HTTP之间加入了SSL/TLS层，主要工作：

1. 加密传输（防被窃听）
2. 数字签名（防止篡改）
3. 数字证书（保证数据来自官方）

### 对称加密和非对称加密

- 对称加密：双方使用同样的密钥加密。速度快。但是怎么安全使双方获得对称密钥是个问题
- 非对称加密：服务器保管私钥，对外公开公钥。速度慢
  - 私钥加密、公钥解密：保证数据不被冒充，是来自官方的（谁都可以看里面是什么，只保证”官方认证“，不能保证不被窃听）
  - 公钥加密、私钥解密：保证信息安全传输到对面，不被窃听。只有对面能解开。



### 防止窃听

*报文在网络传输时，如果被截获（随便抓个包就可以），里面有账号密码，怎么办？*

用对称加密的方式保证双方消息不会被窃听。

为了使双方安全获得对称加密的密钥（会话密钥），用非对称加密的方式安全交换会话密钥

之后双方一直用会话密钥加密，就可以防止窃听了

### 防止篡改

现在虽然黑客不能读出传输的内容，但是如果他在包里随便塞一些垃圾发过来呢？塞垃圾（篡改）是不一定需要知道里面是什么东西的

为了保证双方传输时，对面看到的内容一定是我希望发的内容。在发送前用**摘要算法（哈希函数）**对内容算出一个哈希值，然后哈希值+内容一起加密传输。

黑客如果塞一些垃圾进去，接收方解密后，用带垃圾的内容算出的哈希值就和发送方附带的哈希值不一样，所以知道被篡改了。

*有没有一种可能，黑客直接也对垃圾算出一个哈希值，然后把垃圾+垃圾的哈希值一起发给接收方呢？不行。因为黑客没有密钥，所以不能获得一个密文，使得这个密文用会话密钥解密后=垃圾+垃圾哈希值*

显然这个摘要是需要被加密的，在不同场景下对摘要有不同的加密方式

- 如果在验证官方身份时用到防篡改技术，就要用私钥加密+公钥解密的形式。此时私钥加密哈希值，就是**数字签名**，如果用户将*收到的内容算出的哈希值*和*用公钥解出的数字签名的哈希值*比对没有问题，说明内容来自官方。这个方法会结合数字证书一起使用
- 如果是在正常的数据传输中用到防篡改，则使用会话密钥加密双方的内容+哈希值。原理都是一样的，目的也都是防篡改，但是应用场景不同

### 保证官方

*现在，黑客在中间窃听、篡改你和官方的传输内容。但是上面的流程还有一个问题。首先我们要用非对称加密获得会话密钥，之后我们用会话密钥加密内容+哈希值。又假如我们用非对称加密哈希值。上面所有方式都依赖**公钥**。公钥是官方公开在网上，用户自己去取的。如果公钥是假的呢？那么后面所有措施都无法成立*

因此需要一个绝对权威的中间机构CA，它的作用是：保管好所有交了钱的网站的公钥。并且所有计算机都内置了CA的绝对没有问题的公钥。

在我们绝对信任CA以及电脑中CA的公钥绝对没有问题的前提下，通过上面提过的措施的结合，就是**数字证书**方法。

各网站把自己的公钥交给CA那里，然后CA对公钥数字签名，并把公钥+数字前面+网站信息打包成数字证书。当普通用户需要一个网站的公钥时，把数字证书发给用户。这些信息都是公开的，所以不怕被窃听。

用户用CA的公钥（again：我们基于绝对信任CA+CA的公钥绝对没有问题的基础上使用这个方法）解密，所以我们验证网站给我们的数字证书（中的公钥）确实是CA信任的（私钥加密+公钥机密=验证（持有私钥的）官方）。

所以我们安全地获得了网站的公钥。

也就是说：我们信任CA（表现为：我们放心地使用CA的公钥），而CA信任网站的公钥（表现为：CA将网站公钥发给我们并且用CA的私钥做数字签名），所以我们信任网站的公钥。**（用户的）信任，就是指信任它的公钥，（官方的）认证/信任，就是指官方使用它的私钥加密**
因此这可以形成一个**信任链**。可能网站的公钥（数字证书）是别的中间机构颁发的，而中间机构的证书是CA颁发的。

- 我们现在只信任CA，而CA信任中间机构（表现为：给我们中间机构的数字证书，并用CA的私钥加密），所以我们信任中间机构，并用中间机构的公钥。
- 而中间机构信任网站，中间机构用它的私钥加密网站的数字证书。
- 我们由于已经信任了中间机构（的公钥），所以用中间机构的公钥解密出的网站的公钥也能信任了。



数字证书的签名与校验

![](picture\证书的签名与校验.png)



### SSL/TLS握手阶段四次通信

![HTTPS工作流程](picture\HTTPS工作流程.jpg)



### TLS对数据完整性和来源的保证

- 握手协议：就是上图。四次握手安全交换会话密钥
- 记录协议：规定了HTTP数据的压缩、加密和认证

![](picture\TLS记录协议.png)

可见，通过MAC值（哈希算法得出的校验值）+会话密钥加密，完成了应用数据防窃听+防篡改的目标。而“保证官方“的目标则在握手阶段通过数字签名、数字证书校验等完成



最后：

*数字签名和MAC值显然都是防止篡改+验证来源。只不过数字签名基于非对称加密用于验证官方，MAC基于对称加密用于验证通信中的对方。*

*在安全通信中，非对称加密的方式用于在最开始”拉起“整个安全系统，而非对称加密的方式注定要有人承担”官方“的角色，无论是CA，还是网站官方。在基于非对称加密中获得安全的公钥、以及安全地交换了对称密钥后，就可以让对称密钥发挥主要的作用了*

